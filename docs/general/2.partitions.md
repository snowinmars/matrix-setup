[English](2.partitions.md) | [Русский](2.partitions.ru.md)

Prerequirements:
* [ready to run linux](1.linux.md)

# Partitions

    In this section use the following substitution:

    - 🕷 $USERNAME: your_linux_username
    - 🕷 $NAME:     any_string

    I'll use arch linux, but feel free to marry anyone you love.

## Motivation

You want to hide data from the physical access. If someone steals you PC, it should achieve nothing.

On the same time, you want to make it as painless, as it possible.

The proposal are the following:
* There should be casual linux, that hosts casual servers: ssh, etc
* There should be secured linux subsystem, that hosts secure servers: messengers, etc
* If it's true, there may be no config/lib/data sharing, excluding network connection.

### What should you have

1. PC with linux X
1. Empty drive (hdd/ssd)
1. Linux X installer (flash drive, image, wateva)

### What will you get

1. PC with linux X
1. A volume on the drive, that is
   1. ...not automountable. It means, the volume do nothing after PC reboot. It's enough to unplug PC from a wall outlet to secure everything forever
   1. ...encrypted. That means, the drive is useless without password and mounts with password. The password does not store anywhere and provides by human keyboard typing. No human action - no mount
1. Linux X on the volume as hidden subsystem
   1. You can access the subsystem using chroot or kinda. That's why I choose arch linux: it have working [arch-chroot](https://wiki.archlinux.org/title/Chroot) from the box
   1. The host and the subsystem are in the same network, that means the subsystem can access Internet

## Steps

### Create a separate volume

Just buy and external drive. It's safer even for you: if you experiments on a separate drive, you will not be able to harm your host system.

1. Pick a device `🕷 /dev/sdX`
1. Create a new partition `🕷 /dev/sdXY` on the device. You can use the device `🕷 /dev/sdX` itself, it doesn't matter, until there's only one partition on the disk

#### dm-crypt

Run dm-crypt on `🕷 /dev/sdXY`: see [textguide](https://wiki.archlinux.org/title/Dm-crypt) and [videoguide](https://youtu.be/Lc5BV3P5kjc)

    Do not use any automatization or kinda.
    Be sure that if you plug your PC out of electricity,
    it will NOT restore back without your will

Main steps from guides above:

1. `sudo cryptsetup --verbose --cipher aes-xts-plain64 --key-size 512 --iter-time=4000 --hash sha512 luksFormat 🕷 /dev/sdX`
1. `lsblk` - remember the device
1. `sudo cryptsetup open --type luks 🕷 /dev/sdX 🕷 $NAME`
1. `lsblk` - the device changed
1. `sudo cryptsetup -v status 🕷 $NAME`
1. `sudo cryptsetup open --type plain -d /dev/urandom 🕷 /dev/sdXY 🕷 $NAME`
1. `sudo cryptsetup close 🕷 $NAME`

#### zfs

Run zfs on top of dm-crypt on `🕷 /dev/sdXY`: see [guide](https://github.com/danboid/creating-ZFS-disks-under-Linux) and [another guide](https://gist.github.com/kdwinter/2e779abab2e25f8a0bdea7928860fbb5).

Main steps from guides above:

1. `sudo zpool create -o ashift=12 -m none -R /mnt 🕷 $NAME 🕷 /dev/mapper/$NAME`
1. `sudo zfs set mountpoint=/path/to/dir 🕷 $NAME`
1. `sudo zpool export 🕷 $NAME` - "unmount"
1. `sudo zpool import 🕷 $NAME` - "mount"
1. `sudo chown -R 🕷 $USER:users 🕷 /home/homk/prg/$USER$NAME/$NAME`

#### Using dm-crypt + zfs together

So, full device flow is:

1. `sudo zpool status` - check status of zfs
1. `sudo cryptsetup open 🕷 /dev/sdX 🕷 $NAME` - open ("mount") dm-crypt device
1. `sudo zpool import 🕷 $NAME` - import ("mount") zfs
1. ...you do work...
1. `sudo zpool export 🕷 $NAME` - export ("umount") zfs
1. `sudo cryptsetup close 🕷 $NAME` - close ("umount") dm-crypt device

#### Install linux

Install the linux you love to the dm-crypt + zfs volume. And chroot inside.

There may be no step-by-step guide here, but the point is to achieve the following:

1. From the host system: `ping youtu.be` - ok
1. From the host system: `nmap -p 80 youtu.be` - ok
1. From the subsystem system: `ping youtu.be` - ok
1. From the subsystem system: `nmap -p 80 youtu.be` - ok

If it's true, the network seems fine.

#### Test

**Do test** what happens if you hot unplug the device. Learn how to restore it. I won't give any instructions here, just be creative!

Useful commands:

* `ls /dev/mapper` - list all dm-crypt devices
* `lsblk` - check status of mounted dm-crypt devices
* `sudo cryptsetup -v status 🕷 $NAME` - check status of dm-crypt
* `sudo dmsetup info 🕷 $NAME` - info about 🕷 $NAME
* `sudo lsof | grep 🕷 $NAME` - who uses 🕷 $NAME
* `sudo fuser 🕷 /dev/mapper/$NAME` - who uses 🕷 $NAME

# Next

* [network guide](3.network.md)
