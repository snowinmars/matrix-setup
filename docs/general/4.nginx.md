[English](4.nginx.md) | [Русский](4.nginx.ru.md)

Prerequirements:

* [ready to run linux](1.linux.md)
    * [maybe on secured partition](2.partitions.md)
* [with some ports open](3.network.md) 

# Nginx

    In this section use the following substitution:

    - 🕷 $NGX_DOMAIN: any_domain_you_like

In this guide you'll run an nginx server with ssl, that will return hardcoded string. This server will be used later as an entrypoint to the whole system.

## Create catalogs

You can use commands:

- `mkdir -p ./crt/ ./ngx/acme-challenge`
- `touch ./docker-compose.yaml ./ngx/default.conf ./ngx/cors.conf ./ngx/https.conf ./ngx/Dockerfile`

```
.
├── crt/
├── ngx/
│   ├── acme-challenge/
│   ├── cors.conf
│   ├── default.conf
│   ├── Dockerfile
│   └── https.conf
└── docker-compose.yaml
```

## Create docker compose

```yaml
# ./docker-compose.yaml
version: '3.8'
name: shrub
services:
  shrub-ngx:
    container_name: shrub-ngx
    image: shrub/shrub-ngx:1.0.0
    hostname: 🕷 $NGX_DOMAIN
    # restart: unless-stopped
    build:
      context: ./ngx
      dockerfile: ./Dockerfile
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./ngx/default.conf:/etc/nginx/conf.d/default.conf
      - ./ngx/https.conf:/etc/nginx/https.conf
      - ./ngx/cors.conf:/etc/nginx/cors.conf
      - ./ngx/acme-challenge:/var/www/html/acme-challenge
      - ./crt:/var/www/html/crt
    healthcheck:
      test: [ "CMD-SHELL", "wget -O /dev/null http://localhost || exit 1" ]
      interval: 60s
      timeout: 10s
      retries: 2
      start_period: 10s
      start_interval: 5s

networks:
  default:
    driver: bridge
```

## Create Dockerfile

```dockerfile
# ./ngx/Dockerfile
FROM nginx:alpine AS build

RUN mkdir -p /var/www/html/acme-challenge
RUN mkdir -p /var/www/html/crt
RUN mkdir -p /var/log/nginx/logs
RUN rm /etc/nginx/conf.d/*

EXPOSE 80
EXPOSE 443

CMD [ "nginx", "-g", "daemon off;" ]
```

## Create nginx configs

Create `./ngx/default.conf`, other may stay empty:

```nginx
# ./ngx/default.conf
server {
    listen 80;
    server_name 🕷 $NGX_DOMAIN;

    location ^~ /.well-known/acme-challenge/ {
        allow all;
        default_type "text/plain";
        alias /var/www/html/acme-challenge/;
        break;
    }

    return 200 'hello'; # beware: this line will override acme challenge flow. Drop it, if you need to test acme
}
```

## Sanity check

1. Run `docker compose up`
1. Check that `http://🕷 $NGX_DOMAIN` returns 'hello'.
1. Create a non-empty file in `./ngx/acme-challenge/test.txt`
1. Check that `http://🕷 $NGX_DOMAIN/.well-known/acme-challenge/test.txt` return content of the file (drop the 'return 200' line)

