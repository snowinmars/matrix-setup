[English](2.partitions.md) | [Русский](2.partitions.ru.md)

Требования:

* [готовый к бою линукс](1.linux.ru.md)

# Разделы

    В этой инструкции будут использованы следующие переменные:

    - 🕷 $USERNAME: имя_линукс_юзера
    - 🕷 $NAME:     что_угодно

    Я люблю arch linux, но подойдёт любой.

## Мотивация

Надо скрывать данные от физического доступа. Чтобы весь комп украли - а толку бы не было. 

В то же время, не хочется есть кактус безопасников.

Предлагаю:

* Поставить на комп обычный линукс, который сёрвит обычные программки - ssh или типа того
* Поставить прямо внутрь него копию линукса, который сёрвит секьюрные программки - мессенджеры и вот это вот всё
* Так как оси физически разделены, они шарят только сетевые доступы

### Надо

1. ПК с любым линуксом
1. Пустой диск (hdd/ssd)
1. Установщик линукса (флешка, образ или чего там надо дистрибутиву)

### Будет

1. ПК с линуксом
1. Раздел на диске, который
   1. ...не маунтится сам. То есть, после ребута ПК не происходит ничего. Для того, чтобы закрыть доступ к данным в такой конфигурации, достаточно обесточить ПК 
   1. ...зашифрован. То есть, диск нечитаем без пароля и маунтится с паролем. Пароль нигде не хранится и каждый раз вводится человеком ручками. Нет человека - нет диска
1. Лиукс на этом разделе в качестве скрытой подсистемы
   1. В неё можно зайти через chroot или аналог. Я потому и взял arch linux - у него [arch-chroot](https://wiki.archlinux.org/title/Chroot) из коробки
   1. Хост и подсистема делят одну и ту же сеть. То есть, из подсистемы можно выйти в Интернет

## По шагам

### Создать отдельный раздел

Просто купи отдельный диск. И тебе там спокойнее будет: если ставить эксперименты над отдельным диском, то хрен ты основную систему повредишь.

1. На диске `🕷 /dev/sdX`
1. Создай раздел `🕷 /dev/sdXY`. Можно использовать сам `🕷 /dev/sdX`. Разницы между одним диском и диском с одним разделом не будет.

#### dm-crypt

Натрави dm-crypt на `🕷 /dev/sdXY`: см [текстовую](https://wiki.archlinux.org/title/Dm-crypt) and [видеоинструкции](https://youtu.be/Lc5BV3P5kjc)

    Не используй автоматизацию любого рода.
    Убедись, что ПК не восстановится самостоятельно,
    если ему выключить питание на пару секунд

Выжимка из инструкций выше:

1. `sudo cryptsetup --verbose --cipher aes-xts-plain64 --key-size 512 --iter-time=4000 --hash sha512 luksFormat 🕷 /dev/sdX`
1. `lsblk` - запомни устройство
1. `sudo cryptsetup open --type luks 🕷 /dev/sdX 🕷 $NAME`
1. `lsblk` - устройство изменилось
1. `sudo cryptsetup -v status 🕷 $NAME`
1. `sudo cryptsetup open --type plain -d /dev/urandom 🕷 /dev/sdXY 🕷 $NAME`
1. `sudo cryptsetup close 🕷 $NAME`

#### zfs

Запусти zfs поверх dm-crypt на `🕷 /dev/sdXY`: см. [ту](https://github.com/danboid/creating-ZFS-disks-under-Linux) и [эту инструкции](https://gist.github.com/kdwinter/2e779abab2e25f8a0bdea7928860fbb5).

Выжимка из инструкций выше:

1. `sudo zpool create -o ashift=12 -m none -R /mnt 🕷 $NAME 🕷 /dev/mapper/$NAME`
1. `sudo zfs set mountpoint=/path/to/dir 🕷 $NAME`
1. `sudo zpool export 🕷 $NAME` - "анмаунт"
1. `sudo zpool import 🕷 $NAME` - "маунт"
1. `sudo chown -R 🕷 $USER:users 🕷 /home/homk/prg/$USER$NAME/$NAME`

#### dm-crypt + zfs вместе

Итого, цикл работы таков:

1. `sudo zpool status` - проверяешь статус zfs
1. `sudo cryptsetup open 🕷 /dev/sdX 🕷 $NAME` - открываешь ("маунтишь")диск dm-crypt
1. `sudo zpool import 🕷 $NAME` - импортишь ("маунтишь") zfs
1. ...робота турник качат...
1. `sudo zpool export 🕷 $NAME` - экспортишь ("анмаунтишь") zfs
1. `sudo cryptsetup close 🕷 $NAME` - закрываешь ("анмаунтишь") диск dm-crypt

#### Установи линукс

Поставь любой линукс на раздел с dm-crypt + zfs. И зайди внутрь оси через chroot.

Тут особо ничего не посоветовать, но надо добиться следующего:

1. Из хоста: `ping youtu.be` - ок
1. Из хоста: `nmap -p 80 youtu.be` - ок
1. Из подсистемы: `ping youtu.be` - ок
1. Из подсистемы: `nmap -p 80 youtu.be` - ок

Если всё ок, то сеть работает.

#### Проверка

**Проверь** что происходит, когда зашифрованный диск отключается наживую. Научить восстанавливать его работу. Тут тоже нечего посоветовать, разве что - будь изобретательным!

Полезные команды:

* `ls /dev/mapper` - список всех dm-crypt разделов
* `lsblk` - список статусов всех dm-crypt разделов
* `sudo cryptsetup -v status 🕷 $NAME` - статус dm-crypt
* `sudo dmsetup info 🕷 $NAME` - информация о 🕷 $NAME
* `sudo lsof | grep 🕷 $NAME` - кто использует 🕷 $NAME
* `sudo fuser 🕷 /dev/mapper/$NAME` - кто использует 🕷 $NAME

# Далее

* [Настройка сети](3.network.ru.md)
